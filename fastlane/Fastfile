default_platform(:ios)

platform :ios do
  desc "Собрать и отправить билд в TestFlight"
  lane :beta do
    api_key = app_store_connect_api_key(
      key_id: "4F67HCB9N8",
      issuer_id: "08ac18d7-d3c1-49a2-901b-6956daadbeb7",
      key_filepath: "./fastlane/AuthKey_4F67HCB9N8.p8"
    )

    # Подключение авторизации
    authenticate_with_app_store_connect_api_key(api_key: api_key)

    # Загружаем сертификаты и provisioning profiles из match-репозитория
    match(
      type: "appstore",                        # или development для тестов
      readonly: false,                         # первый запуск = false (чтобы создать)
      app_identifier: "com.TamaleTrack",       # твой bundle id
      git_url: ENV["MATCH_GIT_URL"],           # секрет из GitHub Actions
      username: "richardgleitman@gmail.com"    # твой Apple ID
    )

    # Архив и билд
    build_app(
      scheme: "TamaleTrack",
      export_method: "app-store",
      export_options: {
        compileBitcode: true,
        manageAppVersionAndBuildNumber: true
      }
    )

    # Загрузка в TestFlight
    upload_to_testflight(api_key: api_key)
  end
end

